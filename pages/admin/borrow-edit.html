<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Borrow-Edit</title>
    <link rel="stylesheet" href="../../assets/css/main_page.css" />
    <link rel="stylesheet" href="../../assets/css/admin_pages.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css"
    />
    <script
    src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment-with-locales.min.js"
    integrity="sha512-42PE0rd+wZ2hNXftlM78BSehIGzezNeQuzihiBCvUEB3CVxHvsShF86wBWwQORNxNINlBPuq7rG4WWhNiTVHFg=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  ></script>

    <script src="../../assets/js/db.js"></script>
    <script src="../../assets/js/user/header.js" defer></script>
    <script src="../../assets/js/user/sidebar.js" defer></script>
    <script src="../../assets/js/user/script.js"></script>
  </head>
  <body>
    <nav class="sidebar" id="sidebar">
      <div class="side-header">
        <div class="logo">
          <i class="bi bi-book-half"></i>
          <p>Bookly</p>
        </div>
        <div class="divider-line"></div>
        <div class="nav-list">
          <a href="./admin-dashboard.html" class="nav-items"
            ><i class="bi bi-grid"></i>
            <p>Dashboard</p>
            <div class="tooltip" role="tooltip" data-popper-placement="right">
              Dashboard
              <div class="arrow" data-popper-arrow></div>
            </div>
          </a>
          <a href="./admin_library.html" class="nav-items"
            ><i class="bi bi-building"></i>
            <p>Library</p>
            <div
              class="tooltip"
              role="tooltip"
              style="top: 195px"
              data-popper-placement="right"
            >
              Library
              <div class="arrow" data-popper-arrow></div>
            </div>
          </a>
          <a href="./borrow-list.html" class="nav-items"
            ><i class="bi bi-inboxes"></i>
            <p>Borrow List</p>
            <div
              class="tooltip"
              role="tooltip"
              style="top: 255px"
              data-popper-placement="right"
            >
              Borrow List
              <div class="arrow" data-popper-arrow></div>
            </div>
          </a>
          <a href="./admin_create-book.html" class="nav-items"
            ><i class="bi bi-file-plus"></i>
            <p>Create Book</p>
            <div
              class="tooltip"
              role="tooltip"
              style="top: 315px"
              data-popper-placement="right"
            >
              Create Book
              <div class="arrow" data-popper-arrow></div>
            </div>
          </a>
          <a href="./user_list.html" class="nav-items"
            ><i class="bi bi-person"></i>
            <p>User List</p>
            <div
              class="tooltip"
              role="tooltip"
              style="top: 370px"
              data-popper-placement="right"
            >
              User List
              <div class="arrow" data-popper-arrow></div>
            </div>
          </a>
          <a href="./bookrequest_list.html" class="nav-items "
            ><i class="bi bi-hdd-stack"></i>
            <p>Book Request List</p>
            <div
              class="tooltip"
              role="tooltip"
              style="top: 430px;"
              data-popper-placement="right"
            >
              Book Request List
              <div class="arrow" data-popper-arrow></div>
            </div>
          </a>
        </div>
      </div>
      <div class="side-footer">
        <div class="dark-toggle">
          <a href="#" onclick="darkMode()" class="nav-items"
            ><i class="bi bi-moon-stars-fill dark-light"></i>
            <p class="da-li-text">Dark mode</p>
            <div
              class="tooltip"
              role="tooltip"
              style="bottom: 115px; top: unset"
              data-popper-placement="right"
            >
              Theme
              <div class="arrow" data-popper-arrow></div>
            </div>
          </a>
          <a href="#" class="nav-items" id="sign-out"
            ><i class="bi bi-box-arrow-left"></i>
            <p>Log Out</p>
            <div
              class="tooltip"
              role="tooltip"
              style="bottom: 55px; top: unset"
              data-popper-placement="right"
            >
              Log-Out
              <div class="arrow" data-popper-arrow></div>
            </div>
          </a>
        </div>
      </div>
    </nav>

    <section class="main-container">
      

      <main class="borrow-edit-container">
        <div class="borrow-edit-user-detail">
          <div class="profile-area">
            <div class="profile-field"></div>
          </div>
          <div class="user-name">
            <h4>User Name</h4>
          </div>
          <div class="button-group">
            <button class="save-borrow-edit">Save</button>
            <button
              class="cancel-borrow-edit"
              style="background-color: var(--danger-red)"
            >
              Cancel
            </button>
          </div>
        </div>
        <div class="borrow-status-container">
          <div class="input-group">
            <label for="borrow-status">Borrow Status : <sup>*</sup></label>
            <div class="input-field">
              <select name="borrow-status" id="borrow-status" class="input">
                <option value="Pending">Pending</option>
                <option value="Completed">Completed</option>
              </select>
            </div>
          </div>
        </div>
        <div class="borrow-edit-book-detail">
          <div class="book-detail-left-col">
            <div class="book-detail-left-row">
              <div class="input-group">
                <label for="borrow-edit-book-name">Book-Name :</label>
                <div class="input-field">
                  <input
                    type="text"
                    name="borrow-edit-book-name"
                    id="borrow-edit-book-name"
                    placeholder="Book-Name"
                    class="input"
                    disabled
                  />
                </div>
              </div>
              <div class="input-group">
                <label for="borrow-edit-availability"
                  >Book Availability :</label
                >
                <div class="input-field">
                  <input
                    type="text"
                    name="borrow-edit-availability"
                    id="borrow-edit-availability"
                    placeholder="availability"
                    class="input"
                    disabled
                  />
                </div>
              </div>
            </div>
            <div class="book-detail-left-row">
              <div class="input-group">
                <label for="borrow-edit-borrow-date">Borrow-date :</label>
                <div class="input-field">
                  <input
                    type="date"
                    name="borrow-edit-borrow-date"
                    id="borrow-edit-borrow-date"
                    placeholder="borrow-date"
                    class="input"
                  />
                </div>
              </div>
              <div class="input-group">
                <label for="borrow-edit-due-date">due-date :</label>
                <div class="input-field">
                  <input
                    type="date"
                    name="borrow-edit-due-date"
                    id="borrow-edit-due-date"
                    placeholder="due-date"
                    class="input"
                  />
                </div>
              </div>
            </div>
            <div class="book-detail-left-row">
              <div class="input-group">
                <label for="borrow-edit-remarks">Remarks :</label>
                <div class="input-field">
                  <textarea
                    id="borrow-edit-remarks"
                    placeholder="If there is any damage in book it can be noted here"
                    class="input"
                  ></textarea>
                </div>
              </div>
            </div>
          </div>
          <div class="book-detail-right-col">
            <img
              src="https://www.mswordcoverpages.com/wp-content/uploads/2018/10/Book-cover-page-2-CRC.png"
              alt=""
              width="180px"
            />
          </div>
        </div>
      </main>
    </section>
  </body>

  <script>
    async function showBorrowEdit() {
      const urlParams = new URLSearchParams(window.location.search);
      const borrowId = urlParams.get("id");
      let borrowList = await getData("Borrows");
      let bookList = await getData("Books");
      let userList = await getData("Users");
      const borrowDetail = borrowList.find((b) => b["borrow_id"] == borrowId);

      const bookDetail = bookList.find(
        (b) => b["id"] === borrowDetail["book_id"]
      );
      const userDetail = userList.find(
        (b) => b["id"] == borrowDetail["user_id"]
      );
      const userName = document.querySelector(".user-name h4");
      const saveBtn = document.querySelector(".save-borrow-edit ");
      const cancelBtn = document.querySelector(".cancel-borrow-edit ");
      const profilePic = document.querySelector(
        ".borrow-edit-user-detail .profile-field"
      );
      const bookImage = document.querySelector(".book-detail-right-col img");
      const bookName = document.getElementById("borrow-edit-book-name");
      const borrowStatus = document.getElementById("borrow-status");
      const bookAvailablity = document.getElementById(
        "borrow-edit-availability"
      );
      const bookBorrowDate = document.getElementById("borrow-edit-borrow-date");
      const bookDueDate = document.getElementById("borrow-edit-due-date");
      const bookSubmittedDate = document.getElementById("borrow-edit-remarks");

      userName.innerHTML = userDetail["name"];
      profilePic.style.background = `url(${userDetail["profile"]}) no-repeat center center/cover`;
      bookName.value = bookDetail["title"];
      if (bookDetail["isBorrowable"] === true) {
        bookAvailablity.value = "Available";
      } else {
        bookAvailablity.value = "Not Available";
      }
      bookImage.setAttribute("src", bookDetail["image"]["src"]);
      bookImage.setAttribute("alt", bookDetail["image"]["alt"]);
      bookBorrowDate.value = borrowDetail["borrow_date"];
      bookDueDate.value = borrowDetail["due_date"];
      bookSubmittedDate.value = borrowDetail["remarks"] || "";
      borrowStatus.value = borrowDetail["status"];

      saveBtn.addEventListener("click", function (e) {
        borrowDetail["borrow_date"] = bookBorrowDate.value;
        borrowDetail["due_date"] = bookDueDate.value;
        borrowDetail["return_date"] = moment();
        borrowDetail["status"] = borrowStatus.value;
        if (borrowStatus.value === "Completed") {
          bookDetail["isBorrowable"] = true;
        } else {
          bookDetail["isBorrowable"] = false;
        }
        const userBorrowHistory = borrowList.find(
          (e) => e.id === borrowDetail["id"]
        );
        userBorrowHistory["status"] = borrowStatus.value;
        patchData(`Borrows/${borrowDetail["borrow_id"]}`, borrowDetail).then(
          () => {
            window.location.href = "./borrow-list.html";
          }
        );
      });
      cancelBtn.addEventListener("click", function (e) {
        window.location.href = "./borrow-list.html";
      });
      setLoader(false);
    }
    showBorrowEdit();
  </script>
</html>
