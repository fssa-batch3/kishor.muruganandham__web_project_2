<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link
      rel="icon"
      href="../../assets/images/book-half.svg"
      type="image/x-icon"
    />
    <link rel="stylesheet" href="../../assets/css/main_page.css" />
    <link rel="stylesheet" href="../../assets/css/admin_pages.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css"
    />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment-with-locales.min.js"
      integrity="sha512-42PE0rd+wZ2hNXftlM78BSehIGzezNeQuzihiBCvUEB3CVxHvsShF86wBWwQORNxNINlBPuq7rG4WWhNiTVHFg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="../../assets/js/db.js"></script>
    <script src="../../assets/js/user/script.js"></script>
    <script src="../../assets/js/user/header.js" defer></script>
    <script src="../../assets/js/user/sidebar.js" defer></script>
  </head>
  <body>
    <nav class="sidebar" id="sidebar">
      <div class="side-header">
        <div class="logo">
          <i class="bi bi-book-half"></i>
          <p>Bookly</p>
        </div>
        <div class="divider-line"></div>
        <div class="nav-list">
          <a href="#" class="nav-items active"
            ><i class="bi bi-grid-fill"></i>
            <p>Dashboard</p>
            <div class="tooltip" role="tooltip" data-popper-placement="right">
              Dashboard
              <div class="arrow" data-popper-arrow></div>
            </div>
          </a>
          <a href="./admin_library.html" class="nav-items"
            ><i class="bi bi-building"></i>
            <p>Library</p>
            <div
              class="tooltip"
              role="tooltip"
              style="top: 195px"
              data-popper-placement="right"
            >
              Library
              <div class="arrow" data-popper-arrow></div>
            </div>
          </a>
          <a href="./borrow-list.html" class="nav-items"
            ><i class="bi bi-inboxes"></i>
            <p>Borrow List</p>
            <div
              class="tooltip"
              role="tooltip"
              style="top: 255px"
              data-popper-placement="right"
            >
              Borrow List
              <div class="arrow" data-popper-arrow></div>
            </div>
          </a>
          <a href="./admin_create-book.html" class="nav-items"
            ><i class="bi bi-file-plus"></i>
            <p>Create Book</p>
            <div
              class="tooltip"
              role="tooltip"
              style="top: 315px"
              data-popper-placement="right"
            >
              Create Book
              <div class="arrow" data-popper-arrow></div>
            </div>
          </a>
          <a href="./user_list.html" class="nav-items"
            ><i class="bi bi-person"></i>
            <p>User List</p>
            <div
              class="tooltip"
              role="tooltip"
              style="top: 370px"
              data-popper-placement="right"
            >
              User List
              <div class="arrow" data-popper-arrow></div>
            </div>
          </a>
        </div>
      </div>
      <div class="side-footer">
        <div class="dark-toggle">
          <a href="#" onclick="darkMode()" class="nav-items"
            ><i class="bi bi-moon-stars-fill dark-light"></i>
            <p class="da-li-text">Dark mode</p>
            <div
              class="tooltip"
              role="tooltip"
              style="bottom: 115px; top: unset"
              data-popper-placement="right"
            >
              Theme
              <div class="arrow" data-popper-arrow></div>
            </div>
          </a>
          <a href="#" class="nav-items" id="sign-out"
            ><i class="bi bi-box-arrow-left"></i>
            <p>Log Out</p>
            <div
              class="tooltip"
              role="tooltip"
              style="bottom: 55px; top: unset"
              data-popper-placement="right"
            >
              Log-Out
              <div class="arrow" data-popper-arrow></div>
            </div>
          </a>
        </div>
      </div>
    </nav>

    <section class="main-container">
      

      <main class="dashboard-container">
        <div class="first-row">
          <canvas id="genreChart" height="380px"></canvas>
        </div>
        <div class="second-row">
          <div class="comment-scroller">
            <h4>Recent Comments</h4>
            <div class="marquee">
              <div class="marquee__item"></div>
            </div>
          </div>
          <canvas id="bookChart" class="chart-style"></canvas>
          <canvas id="detailChart" class="chart-style"></canvas>
        </div>
      </main>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      async function recentComments() {
        try {
          const commentList = await getData("Comments");
          const userList = await getData("Users");
          let sortedCommentList = commentList?.sort((a, b) => {
            const timeA = new Date(a.time);
            const timeB = new Date(b.time);
            return timeB - timeA;
          });
          const filteredCommentList = sortedCommentList?.filter(
            (e) => e["isActive"] == true
          );
          const loopLength =
            filteredCommentList?.length < 10 ? filteredCommentList?.length : 10;
          for (let i = 0; i < loopLength; i++) {
            const comment = filteredCommentList[i];
            const user = userList.find((user) => user.id === comment.user_id);
            createScrollComment(comment, user);
          }
        } catch (error) {
          console.error("Error getting comment data:", error);
        }
      }

      function createScrollComment(comment, user) {
        const parentElement = document.querySelector(".marquee__item");
        const scrollCommentWrapper = document.createElement("div");
        scrollCommentWrapper.className = "scroll-comment-wrapper";

        const scrollCommentProfile = document.createElement("img");
        scrollCommentProfile.className = "scroll-comment-profile";
        scrollCommentProfile.src = user["profile"];
        scrollCommentProfile.alt = user["name"];

        const scrollContent = document.createElement("div");
        scrollContent.className = "scroll-content";

        const scrollUsername = document.createElement("p");
        scrollUsername.className = "scroll-username";
        scrollUsername.textContent = user["name"];

        const scrollCommentMessage = document.createElement("p");
        scrollCommentMessage.className = "scroll-comment-message";
        scrollCommentMessage.textContent = comment["description"];

        const momentTime = moment(comment["time"]);

        const scrollCommentTimestamp = document.createElement("span");
        scrollCommentTimestamp.className = "scroll-comment-timestamp";
        scrollCommentTimestamp.textContent = momentTime.fromNow();

        scrollContent.appendChild(scrollUsername);
        scrollContent.appendChild(scrollCommentMessage);

        scrollCommentWrapper.appendChild(scrollCommentProfile);
        scrollCommentWrapper.appendChild(scrollContent);
        scrollCommentWrapper.appendChild(scrollCommentTimestamp);

        parentElement.append(scrollCommentWrapper);
      }
      recentComments();

      async function showChart() {
        const bookList = await getData("Books");
        const userList = await getData("Users");
        const borrowedBook = await getData("Borrows");
        const commentList = await getData("Comments");
        const bookRequestList = await getData("BookRequests");
        const bookRequestLength = bookRequestList.length;
        const commentLength = commentList?.length;
        const userLength = userList.length;
        const borrowedBookLength = borrowedBook?.filter(
          (e) => e.status === "Pending"
        )?.length;
        const booksLength = bookList.filter(
          (book) => book.isActive && book.isBorrowable
        ).length;
        const activeBooksLength = bookList.filter(
          (book) => book.isActive
        ).length;
        
        const tagsArray = await getBookGenres();
        
        const tagValues = Object.values(tagsArray);
        const tagKeys = Object.keys(tagsArray);

        Chart.defaults.font.size = 16;
        new Chart(
          document.getElementById("genreChart").getContext("2d"),
          {
            type: "bar",
            data: {
              labels: tagKeys,
              datasets: [
                {
                  label: "No of Book in specific Genres",
                  backgroundColor: "#8773e726",
                  borderColor: "#8875e8",
                  borderWidth: 1,
                  borderRadius: 10,
                  maxBarThickness: 50,
                  data: tagValues,
                  hoverBackgroundColor: "#8875e8",
                  hoverBorderColor: "#8773e726",
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  ticks: {
                    color: "#000000",
                    stepSize: 3,
                  },
                  beginAtZero: true,
                  max: activeBooksLength,
                },
                x: {
                  ticks: {
                    color: "#000000",
                  },
                  beginAtZero: true,
                },
              },
              plugins: {
                legend: {
                  position: "bottom",
                },
              },
              animation: {
                delay: 50,
              },
            },
          }
        );

        new Chart(
          document.getElementById("bookChart").getContext("2d"),
          {
            type: "pie",
            data: {
              labels: ["No of books available", "No of books borrowed"],
              datasets: [
                {
                  label: "Books",
                  data: [booksLength, borrowedBookLength],
                  backgroundColor: ["rgb(255, 99, 132)", "rgb(54, 162, 235)"],
                  hoverOffset: 10,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
            },
          }
        );

        new Chart(
          document.getElementById("detailChart").getContext("2d"),
          {
            type: "doughnut",
            data: {
              labels: ["Users", "Comments", "Books requested"],
              datasets: [
                {
                  label: "Total",
                  data: [userLength, commentLength, bookRequestLength],
                  backgroundColor: ["Orange", "lightcoral", "teal"],
                  hoverOffset: 10,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
            },
          }
        );
        setLoader(false)
      }
      showChart();
    </script>
  </body>
</html>
